<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Picture Persistence Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #results {
            margin-top: 20px;
        }

        .log-entry {
            padding: 5px;
            margin: 2px 0;
            font-family: monospace;
            font-size: 12px;
        }

        img {
            max-width: 100px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <h1>Profile Picture Persistence Test</h1>

    <div class="test-section info">
        <h3>Test Instructions</h3>
        <p>This test will verify that profile pictures persist through login/logout cycles.</p>
        <ol>
            <li>Click "Login" to authenticate</li>
            <li>Verify profile picture is displayed</li>
            <li>Click "Logout"</li>
            <li>Click "Login" again</li>
            <li>Verify profile picture is still displayed</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Actions</h3>
        <button onclick="testLogin()">1. Login</button>
        <button onclick="testGetMe()">2. Get Current User</button>
        <button onclick="testLogout()">3. Logout</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="test-section">
        <h3>Current State</h3>
        <div id="currentState">
            <p><strong>Token:</strong> <span id="tokenStatus">None</span></p>
            <p><strong>User:</strong> <span id="userStatus">Not logged in</span></p>
            <p><strong>Profile Picture:</strong> <span id="pictureStatus">None</span></p>
            <div id="picturePreview"></div>
        </div>
    </div>

    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:5000';
        const TEST_USER = {
            email: 'burgessglay12@gmail.com',
            password: 'Carp12345@'
        };

        let token = localStorage.getItem('token');
        let currentUser = null;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const entry = document.createElement('div');
            entry.className = `test-section ${type} log-entry`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.insertBefore(entry, results.firstChild);
            console.log(message);
        }

        function updateState() {
            document.getElementById('tokenStatus').textContent = token ? 'Present' : 'None';
            document.getElementById('userStatus').textContent = currentUser
                ? `${currentUser.firstName} ${currentUser.lastName} (${currentUser.email})`
                : 'Not logged in';

            const pictureStatus = document.getElementById('pictureStatus');
            const picturePreview = document.getElementById('picturePreview');

            if (currentUser && currentUser.profilePicture) {
                pictureStatus.textContent = currentUser.profilePicture;
                picturePreview.innerHTML = `<img src="${API_URL}${currentUser.profilePicture}" alt="Profile Picture" />`;
            } else {
                pictureStatus.textContent = 'None';
                picturePreview.innerHTML = '';
            }
        }

        async function testLogin() {
            try {
                log('Attempting login...', 'info');
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(TEST_USER)
                });

                if (!response.ok) {
                    throw new Error(`Login failed: ${response.status}`);
                }

                const data = await response.json();
                token = data.token;
                currentUser = data.user;
                localStorage.setItem('token', token);

                log(`✓ Login successful!`, 'success');
                log(`  User: ${currentUser.firstName} ${currentUser.lastName}`, 'success');
                log(`  Email: ${currentUser.email}`, 'success');
                log(`  Has profilePicture: ${!!currentUser.profilePicture}`, 'success');
                log(`  ProfilePicture: ${currentUser.profilePicture || 'None'}`, 'success');

                if (!currentUser.profilePicture) {
                    log('⚠ WARNING: profilePicture is missing from login response!', 'error');
                } else {
                    log('✓ profilePicture is present in login response', 'success');
                }

                updateState();
            } catch (error) {
                log(`✗ Login failed: ${error.message}`, 'error');
            }
        }

        async function testGetMe() {
            try {
                if (!token) {
                    log('⚠ No token available. Please login first.', 'error');
                    return;
                }

                log('Fetching current user with /api/auth/me...', 'info');
                const response = await fetch(`${API_URL}/api/auth/me`, {
                    headers: {
                        'x-auth-token': token
                    }
                });

                if (!response.ok) {
                    throw new Error(`Get user failed: ${response.status}`);
                }

                const data = await response.json();
                currentUser = data;

                log(`✓ /api/auth/me successful!`, 'success');
                log(`  User: ${currentUser.firstName} ${currentUser.lastName}`, 'success');
                log(`  Email: ${currentUser.email}`, 'success');
                log(`  Has profilePicture: ${!!currentUser.profilePicture}`, 'success');
                log(`  ProfilePicture: ${currentUser.profilePicture || 'None'}`, 'success');

                if (!currentUser.profilePicture) {
                    log('⚠ WARNING: profilePicture is missing from /api/auth/me response!', 'error');
                } else {
                    log('✓ profilePicture is present in /api/auth/me response', 'success');
                }

                updateState();
            } catch (error) {
                log(`✗ Get user failed: ${error.message}`, 'error');
            }
        }

        function testLogout() {
            log('Logging out...', 'info');
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            log('✓ Logged out successfully', 'success');
            log('  Token cleared from localStorage', 'success');
            log('  User state cleared', 'success');
            updateState();
        }

        function clearLogs() {
            document.getElementById('results').innerHTML = '';
        }

        // Initialize state on load
        updateState();

        if (token) {
            log('Found existing token in localStorage', 'info');
            testGetMe();
        } else {
            log('No token found. Please login to test.', 'info');
        }
    </script>
</body>

</html>